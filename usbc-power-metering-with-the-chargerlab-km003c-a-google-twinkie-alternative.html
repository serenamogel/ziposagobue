<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Hardware Design and Software Interface | PicoBlog</title><meta name=generator content="Hugo 0.98.0"><meta name=description content="The internal layout of all USB-PD sniffers is quite similar. A microcontroller acts as the control center (interfacing with the data monitoring host and tapping into the CC lines). Power monitoring ADCs (TI INA family in most cases) are placed on the VBUS and VCONN lines after placing a shunt resistor in the path. These INA chips interface with the microcontroller over an I2C bus. The schematic for the Twonkie 2."><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cayman/css/normalize.css><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet type=text/css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cayman/css/cayman.css><link rel=apple-touch-icon sizes=180x180 href=./apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=./favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=./favicon-16x16.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css integrity=sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js integrity=sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><section class=page-header><h1 class=project-name>PicoBlog</h1><h2 class=project-tagline></h2><nav><a href=./index.html class=btn>Blog</a>
<a href=./sitemap.xml class=btn>Sitemap</a>
<a href=./index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>Hardware Design and Software Interface</h1><div><strong>Publish date: </strong>2024-04-09</div><p>The internal layout of all USB-PD sniffers is quite similar. A microcontroller acts as the control center (interfacing with the data monitoring host and tapping into the CC lines). Power monitoring ADCs (TI INA family in most cases) are placed on the VBUS and VCONN lines after placing a shunt resistor in the path. These INA chips interface with the microcontroller over an I2C bus. The schematic for the <a href=#>Twonkie 2.0</a> (a Twinkie clone with updated components that is easier to prepare for DIY folks) is reproduced below.</p><p align=center><a href=#><img alt src=https://cdn.statically.io/img/images.anandtech.com/doci/18944/twonkie-schematic_575px.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a><br><i>Twonkie 2.0 Schematic - STM32F072 + 2x INA237 + 2x 12 mOhm Shunt Resistors</i></p><p>The Google Twinkie / USBC-TKEY differs only slightly from the above schematic, with 2x INA231 power monitoring ADCs in place of the 2x INA237. There are multiple resistors in the CC observation path, and these enable the placement and removal of the Rp / Ra / Rd from the Twinkie's CLI. The STM32F072 microcontroller has a Cortex-M0 CPU running at 48 MHz, 128KB of flash memory, and a 16KB SRAM.</p><p>The ChargerLAB KM003C's structure is likely to be similar to the above. Based on the <a href=#>photograph of the KM002C's PCB</a> (the KM003C is an updated version with a larger screen, gravity sensor, and a supercapacitor), the main differences appear to be the use of a Huada HDSC HC32F460 microcontroller, multiple INA228 ADCs, and 20 mOhm shunt resistors.</p><p align=center><a href=#><img alt height=463 src=https://cdn.statically.io/img/images.anandtech.com/doci/18944/km002c-board_575px.png width=402 style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a><br><i>KM002C PCB, with the TI INA228 ADC boxed in red</i></p><p>The HC32F460 is a highly advanced microcontroller compared to the STM32F072. It has a Cortex-M4 CPU (with floating point support) running at 200 MHz, 512KB of flash memory, and 192KB of SRAM. This allows the implementation of a fairly complicated user interface with built-in real-time graphing capabilities - features that are not present in the original Twinkie design. We believe that the KM003C includes at least 5 ADCs in order to measure the voltage on both CC lines as well as the D+ and D- lines (in addition to the VBUS). Voltage measurement on the D+ / D- pins is apparently necessary in order to detect and support custom fast-charging protocols, as indicated in the table below from the KM003C's user manual.</p><p align=center><a href=#><img alt src=https://cdn.statically.io/img/images.anandtech.com/doci/18944/fcp-dp-dm-voltages_575px.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>One of the bugs in the KM003C hardware design that has been acknowledged by ChargerLAB is the absence of support for USB 2.0 data passthrough. It is likely that the voltage monitoring on these lines for fast charging protocol detection purposes is breaking the data lines for normal operation. It is an unfortunate side-effect that hopefully gets fixed by ChargerLAB in the next hardware iteration.</p><h3>On-Device Interface</h3><p>Moving on to the external hardware aspects, the KM003C is equipped with a vibrant 240 x 240 1.54" IPS screen and four physical push buttons. These allow the user to navigate through the various on-screen options for activation of different features, and also include special signals to modify certain settings quickly (such as a long press on the 'Confirm' button to alter the sampling rate when the dashboard screen is active). The gallery below presents the various features available via the device screen.</p><p>After power up (and showing an optional startup image set up through the PC software), the screen lights up with the dashboard that provides important information at a glance - the voltage, current, and power consumption inferred from the parameters on the VBUS line, the charging protocol (if applicable), and voltages on the CC and D+/D- lines. The next interface is the application screen from which the charging protocol support detection can be triggered. This involves ensuring stable power supply through the HID port and connecting the Type-C male port to the power supply of interest. The female port should be left unconnected. Under this option in the interface, it is possible to trigger cable simulation (by selecting 'No e-marker'), request for a specific PD type (after selecting 'Auto'), and scan for different charging protocols support. Yet another option under the application screen is 'Modules'. Under this, various value-adds such as USB-C cable e-marker reading, and Apple charger genuineness checking are currently available. ChargerLAB plans to add testing for cable resistance also in the future.</p><p>Under the Settings screen, the display brightness and startup screen can be adjusted. Storage management options are also available. Language settings (Chinese or English) and device information, as well as the option to reset all settings to default can all be accessed from the same screen.</p><p>The real-time curves interface allows the user to view the voltage / current on the VBUS line, or the voltages on the D+ / D- lines, or the voltages on the CC1 / CC2 lines as a function of time. The screen also helpfully notes the sampling rate on the top left corner. The data storage interface records the charge and energy values from the INA ADC chip for the VBUS line. The save interval is configurable and the starting and stopping of the recording can be triggered based on the current in the line. Up to 40 different data sets of 10000 points each can be stored in the 4MB of memory available in the device.</p><h3>PC Software Features</h3><p>ChargerLAB provides a Windows application that can be used to manage multiple USB power testers from a single pane. Our evaluation was with a single KM003C in the list, which is displayed on the left in the interface. The application starts up with a 'Data Recorder' view. The top part of this view has all the parameters present in the on-device screen's dashboard interface, while the bottom part has a real-time chart (with the available parameters on either side of the title). On the right side, a button to trigger the chart updates is available. The sampling rate can also be adjusted. Available rates are 1, 10, 50, and 1000 samples per second. The cache depth on the PC side is also configurable.</p><p>The software interface language can be modified from the triangular drop down on the top right near the window controls. However, some options continue to remain in Chinese even after the language is set to English. However, the software is intuitive enough for that to not be too much of a concern. The device firmware, as well as the application itself, can be updated from within the program. The 'PD Analyzer' view shows a real-time view of the various voltages and currents, along with a tabular view of the PD handshake process. Various other options such as saving graphs, recording data to a CSV or SQLite DB on the PC, etc. are available, as shown in the gallery above.</p><h3>Open APIs</h3><p>The Windows application is closed-source, but ChargerLAB provides some documentation in their HID Demo archive. The document is in Chinese, but I used Google Translate to get an inkling of the contents. From previous reviews, I have found that links often go stale. In order to avoid that with the KM003C API description, a screenshot of the translated version is provided below.</p><p align=center><a href=#><img alt src=https://cdn.statically.io/img/images.anandtech.com/doci/18944/final-api-doc_575px.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a><br><i>Click for a higher-resolution version of the API document</i></p><p>It is possible that ChargerLAB might update the APIs in the future. In that case, the latest version can be obtained from the FAQ section on their <a href=#>support page</a>. ChargerLAB states there are three interfaces available - as a WinUSB (vendor specific interface) device, a HID device, or a virtual serial port (CDC). The next couple of sections take a look at how these interfaces can be taken advantage of in different operating systems.</p><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmivp6x7orrAp5utnZOde6S7zGiqoaenZH55hZNtZq6rkph6sbvWnqlmpZWpsrO1zaBksKGknXq1tMRmmqGZopyys7jAm2SkpWBlgKR5wGaeqKeXobJuwNaipaShlWKurcDEq6WarJmrsnB%2B</p><footer class=site-footer><span class=site-footer-credits>Made with <a href=https://gohugo.io/>Hugo</a>. © 2022. All rights reserved.</span></footer></section><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>